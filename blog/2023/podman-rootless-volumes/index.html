<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Podman Rootless Volumes | Levande landskap</title> <meta name="author" content="Carl Johan Rehn"> <meta name="description" content=""> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/allehanda/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/allehanda/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/allehanda/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/allehanda/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://carljohanrehn.github.io/allehanda/blog/2023/podman-rootless-volumes/"> <link rel="stylesheet" href="/allehanda/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/allehanda/assets/js/theme.js?2ed62375d27d1acd85fb25a8d933282f"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/allehanda/">Levande landskap</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/allehanda/">about</a> </li> <li class="nav-item "> <a class="nav-link" href="/allehanda/blog/">blog</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Podman Rootless Volumes</h1> <p class="post-meta"> April 24, 2023 </p> <p class="post-tags"> <a href="/allehanda/blog/2023"> <i class="fa-solid fa-calendar fa-sm"></i> 2023 </a> ¬† ¬∑ ¬† <a href="/allehanda/blog/tag/podman"> <i class="fa-solid fa-hashtag fa-sm"></i> Podman</a> ¬† <a href="/allehanda/blog/tag/rootless-volumes"> <i class="fa-solid fa-hashtag fa-sm"></i> rootless-volumes</a> ¬† ¬† ¬∑ ¬† <a href="/allehanda/blog/category/cross-python-development"> <i class="fa-solid fa-tag fa-sm"></i> cross-python-development</a> ¬† </p> </header> <article class="post-content"> <div id="markdown-content"> <hr> <ul> <li>Location: ~/my-pak/cross-python-development/</li> <li>File: README-podman-rootless-volumes</li> </ul> <hr> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code></code></pre></div></div> <p>https://www.tutorialworks.com/podman-rootless-volumes/</p> <p>Using volumes with rootless podman, explained</p> <p>Written by Tom Donohue</p> <p>Updated: 12 November 2022</p> <p>14 Comments</p> <p>Podman is the new tool for running containers. It‚Äôs daemonless (unlike docker) and it‚Äôs designed to play a bit nicer in the Linux ecosystem, from the ground up.</p> <p>Podman is architected like classic Linux tools ‚Äì it‚Äôs lightweight, it doesn‚Äôt ask for more permissions than it needs, and it cooperates willingly with SELinux. (Unlike some of us!)</p> <p>However, you might have realised that some commands which worked fine in Docker, simply don‚Äôt work in Podman; doubly so, when SELinux is in charge.</p> <p>You‚Äôre tearing your hair out (if you have any).</p> <p>You get all sorts of errors about permissions, and‚Ä¶. you desperately want to avoid disabling SELinux, but you just end up reaching for setenforce 0 and running everything with sudo.</p> <p>Stop! üöè No, I mean stop. üõë We can fix this. You don‚Äôt have to SELinux if you run as root - meme</p> <p>Just say no.</p> <p>In this article I‚Äôll go through how to share a volume from your host machine with podman, when you‚Äôre running rootless containers.</p> <p>I‚Äôll also share a podman command you can use which really helps you in these situations. On this page</p> <p>Rootless podman vs rootful at a glance</p> <ul> <li>Understanding how rootless podman works</li> <li>Rootless containers share the same user namespace</li> <li>podman unshare lets you run a command in the same user namespace as your containers</li> <li>How to allow a rootless podman container to write to a volume <ul> <li>Get the UID of the container user first</li> <li>Use podman unshare chown to grant the container user ID permissions to write to your directory</li> <li>Check that the permissions are OK, by listing the directory inside the container</li> <li>Or, you could just run your process as the root user inside the container</li> </ul> </li> </ul> <p>Advertisements Rootless podman vs rootful at a glance</p> <p>When you‚Äôre running containers with Podman, you‚Äôre probably going to run in either rootless or rootful modes. The way you choose to run Podman affects the user ID that your process will run as. Therefore, it affects the things that your containerised process is permitted to do.</p> <p>The table below shows four possible rootless/rootful operating modes of Podman, and how they really work in practice: You run podman as.. With containerised process running as.. The actual UID visible on the host is‚Ä¶ root root 0 root non-root The UID of the user running the process inside the container non-root root Your UID non-root non-root A non-root UID</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The first column is how you‚Äôre running podman. Do you run the command as the root user (e.g. sudo podman run....), or not?

The second column is the user that the container process is running as. You can set this explicitly with podman, using the -u option - e.g. podman run -u root...

The third column shows who the process is really running as, on the host. That is, if you run ps -ef on the host, and find your containerised process, this is the UID that you will see in the process list.
</code></pre></div></div> <p>As you can see, the ultimate user ID of the process can vary quite a lot! Let‚Äôs take a look at how that part works. Understanding how rootless podman works</p> <p>Rootless podman (running Podman as a non-root user) needs to do some gymnastics to get the same container experience you know from docker, but without requiring root. Juggler icon</p> <p>Podman juggles UIDs</p> <p>Source: monkik/Flaticon</p> <p>When you run rootless podman, it uses a user namespace to map between the user IDs in the container and the user IDs on your host. What are user namespaces?</p> <p>In Podman‚Äôs user namespace, there is a new set of user IDs and group IDs, which are separate from the UIDs and GIDs on your host. Illustration of mapping of User IDs between a parent and user namepsace</p> <p>By using a user namespace, and using a map of UIDs, Podman can make a container process can appear to run as user 200 inside a container, but actually it‚Äôs running as a different user ID on the host.</p> <p>You can see the actual mappings by viewing the file /proc/self/uid_map inside your container.</p> <p>The Linux manpages have lots more detail on how this works. Check out man 7 user_namespaces</p> <p>If you‚Äôve got a few minutes, and you‚Äôre looking for a snappy video that explains this well, check out this video from Red Hat on rootless Podman: Rootless containers share the same user namespace</p> <p>All rootless containers run by you, are run inside the same user namespace. The engineers behind Podman explain this in this article on the ‚Äòbehind-the-scenes‚Äô process of Podman:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>All rootless containers must be run in the same user namespace. If they are not, some things (like sharing the network namespace from another container) would be impossible.
</code></pre></div></div> <p>By using the same user namespace, your containers can share resources with each other, without needing to ask for root privileges.</p> <p>It uses this user namespace to mount filesystems, or run a container which accesses more than one user ID (UID) or group ID (GID).</p> <p>This mapping is fine for most situations, except when the container needs to be able to share something with the host, like a volume.</p> <p>But - here‚Äôs the important thing: When the container runs, any volumes which are shared with it, will appear inside the user namespace as owned by root/root.</p> <p>When the container runs, any volumes which are shared with it, will appear inside the user namespace as owned by root/root. Because the mapping will map your UID on the host (e.g. 1000) as root (0) in the container.</p> <p>Here‚Äôs an example of what I mean. I run rootless podman as a non-root user (user 200), and mount a volume from my host:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>podman run <span class="nt">--user</span> 200 <span class="nt">-it</span> <span class="nt">-v</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>/myfolder:/mnt/myfolder:Z busybox
</code></pre></div></div> <p>Now inside the container, look at the permissions on the mounted directory:</p> <p>~ $ ls -al /mnt total 16 drwxr-xr-t 3 root root 4096 Jan 3 15:50 . dr-xr-xr-x 14 root root 4096 Jan 3 15:50 .. drwxr-xr-x 2 root root 4096 Jan 3 15:50 public</p> <p>The directory is owned by root ‚Äì not user ‚Äú200‚Äù, or my user ID.</p> <p>This means that if you‚Äôre running your container process as a non-root user, it won‚Äôt be able to write to that directory.</p> <p>So how do we change the owner of the directory in the container, so the user can write to it?</p> <p>And how can we troubleshoot and run commands in that same user namespace, when things go wrong ‚Äì without having to start a container?</p> <p>This is where podman unshare comes in. podman unshare lets you run a command in the same user namespace as your containers</p> <p>podman unshare runs a command in Podman‚Äôs modified user namespace. It‚Äôs intended to be run with rootless podman (where you run podman as a non-root user).</p> <p>Since Podman uses user namespaces to make the magic of different user IDs and group IDs work, it would be helpful if we had a way of accessing this same user namespace, when we need to fix or investigate something.</p> <p>This is where podman unshare comes in. From the manpage for podman-unshare:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>podman unshare is useful for troubleshooting unprivileged operations and for manually clearing storage and other data related to images and containers.
</code></pre></div></div> <p>It uses the unshare command, part of the Linux kernel. unshare is one of the commands that actually makes user namespaces possible, and therefore containers.Advertisements</p> <p>From the Linux manpage for unshare:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>unshare - run program in new namespaces
The unshare command creates new namespaces ‚Ä¶ and then executes the specified program.
</code></pre></div></div> <p>Why is it called ‚Äúunshare‚Äù?</p> <p>When you use podman unshare, you‚Äôre effectively jumping out of your normal namespace, and into the Podman user namespace. Advertisements Out of Space - Melody line</p> <p>Out of (user) namespace</p> <p>Source: Ukulele Go</p> <p>It‚Äôs like executing the unshare command as the Podman process. So you can execute a command in the same user namespace, such as changing file permissions, or browsing your filesystem, if you need to.</p> <p>You can check out Dan Walsh‚Äôs article on Opensource.com for more information on how rootless Podman works.</p> <p>So now we know what podman unshare does, how is it relevant to sharing a directory? How to allow a rootless podman container to write to a volume</p> <p>So this brings us on to the task in hand. If you want to run rootless podman to run containers, but you want to share a directory from your host, how do you do this?</p> <p>I do this on my laptop, because I run Nexus, the artifact repository, in a container. I want it to save its artifacts to a location on my host machine, so that if the container dies, I don‚Äôt have to download everything again.</p> <p>Putting it all together, here are the steps:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Determine which user account is running the process within your container.

Enter Podman‚Äôs user namespace, and grant this user permissions to write to your directory.

Mount the volume when you run the container, add the proper SELinux label to allow the container user to write.

Check, and double-check ;-)
</code></pre></div></div> <p>Get the UID of the container user first</p> <p>First you need to know which UID the container is running as.</p> <p>The user is specified in the Dockerfile of the image you‚Äôre running (in the USER line).</p> <p>Or, when you‚Äôre running the container, you can set the user explicitly using the podman run ‚Äìuser <id> option. Use podman unshare chown to grant the container user ID permissions to write to your directory</id></p> <p>Next we need to change the UID/GID of the volume directory in the rootless Podman user namespace, to make it the same as the UID/GID of the container user.</p> <p>In my case, the nexus container runs as UID 200. I can see how my rootless container would ‚Äúsee‚Äù the filesystem using podman unshare:</p> <p>$ podman unshare ls -al /home/tom/myshares drwx‚Äìx‚Äìx. 58 root root 4096 Dec 25 13:45 . drwx‚Äìx‚Äìx. 8 root root 4096 Nov 18 16:00 .. drwxrwxr-x. 6 root root 4096 May 18 2020 nexus2</p> <p>As you can see, the nexus2 directory is owned by root.</p> <p>This isn‚Äôt good, because when my container starts, it will want to write to that directory. And since the user running nexus in the container is user 200 and not root, it will fail.</p> <p>So I use the chown command to set the UID/GID of the shared directory, and I run this command in my Podman user namespace:</p> <p>podman unshare chown 200:200 -R /home/tom/myshares/nexus2</p> <p>So far so good.</p> <p>How can we check that things are working? Check that the permissions are OK, by listing the directory inside the container</p> <p>Now I want to make sure that when my Nexus container starts, it will be able to write to that folder.</p> <p>So I run the rootless container. Using the -v option, I mount my volume as /sonatype-work in the container. And I override the entrypoint, so that I launch straight into a shell (/bin/sh):</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>podman run <span class="nt">-it</span> <span class="nt">--rm</span> <span class="nt">--name</span> nexus2 <span class="se">\</span>
    <span class="nt">-v</span> /home/tom/myshares/nexus2:/sonatype-work:Z <span class="se">\</span>
    sonatype/nexus /bin/sh
</code></pre></div></div> <p>Note that I add the :Z flag to the volume. This tells Podman to label the volume content as ‚Äúprivate unshared‚Äù with SELinux. This label allows the container to write to the volume, but doesn‚Äôt allow the volume to be shared with other containers. This syntax is also used in the docker command.</p> <p>Once I‚Äôm inside the container, I can check that I now ‚Äúown‚Äù the directory as the nexus user. If I own the directory, then I should be able to write to it:</p> <p>$ ls -al / | grep sonatype-work drwxr-xr-x. 15 nexus nexus 4096 Sep 27 13:29 sonatype-work</p> <p>This ls command shows me that the sonatype-work directory now appears to be owned by nexus/nexus when inside the container. Result! ‚úÖ</p> <p>When I next start the container, the nexus user will have permissions to write to this directory. Or, you could just run your process as the root user inside the container</p> <p>Another option is to run as the root user inside the container. (Yes, rather confusingly, you can run a rootless container, and set the container user to root, and the process will run as your unprivileged user on the host)</p> <p>To run your process as the root user in the container, use -u root:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>podman run <span class="nt">-it</span> <span class="nt">--rm</span> <span class="nt">--name</span> nexus2 <span class="se">\</span>
    <span class="nt">-v</span> /home/tom/myshares/nexus2:/sonatype-work:Z <span class="se">\</span>
    <span class="nt">-u</span> root <span class="se">\</span>
    sonatype/nexus /bin/sh
</code></pre></div></div> <p>Don‚Äôt forget to add the :Z suffix.</p> <p>Now when I enter my sh shell, I will be root inside the container.</p> <p>Running as root in the container is a bit more portable, but it‚Äôs cheating. We really shouldn‚Äôt be running anything as root, even inside a container. For this reason, this solution isn‚Äôt recommended for production setups. TLDR</p> <p>You‚Äôve skipped this whole article and that makes me a little sad but I‚Äôm not surprised.</p> <p>But, if you really want the super-condensed TLDR:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Rootless Podman uses user namespaces to run container processes

podman unshare allows you to run a command inside the Podman user namespace

Change the owner of the directory inside this namespace, to ensure your container user can write to it.
</code></pre></div></div> </div> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> ¬© Copyright 2024 Carl Johan Rehn. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/george-gca/multi-language-al-folio" rel="external nofollow noopener" target="_blank">multi-language-al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/allehanda/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/allehanda/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/allehanda/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/allehanda/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/allehanda/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/allehanda/assets/js/copy_code.js?9b43d6e67ddc7c0855b1478ee4c48c2d" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>